<!DOCTYPE html>
<html>

<head>
    <title>Arvandor</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
</style>

<body>
    <script type="module">
        import Enemigo from './resources/Enemigo.js';
        import Plataforma from './resources/Plataforma.js';
        import Utils from './resources/Utils.js';
        import EnemyUtils from './resources/EnemyUtils.js';
        import Moneda from './resources/Moneda.js';
        class Arvandor extends Phaser.Scene {

            constructor() {
                super('Arvandor');
                this.weaponIndex = 0;
                this.weapon = 'sword';
                this.weaponX = 0;
                this.rocabroteText = 'Buenas, viajero. ¿Qué te trae por aquí?';
                this.options = ['¿Quién eres?', '¿Dónde estoy?', '¿Qué haces aquí?'];
                this.inAction = false;
                this.action = false;
                this.lives = 3;
                this.hearts = [];
                this.isAlive = true;
                this.isMoving = false;
                this.isJumping = false;
                this.isAttacking = false;
                this.isBurning = false;
                this.glitch = 0;
                this.glitched = false;
                this.speed = 300;
                this.invincible = false;
                this.coinCount = 0;
                this.currentWeapon;
                this.weaponOverlap = null;
                this.isDefending = false;
                this.arrows = 10;
                this.arrowCooldown = false;
                this.weapons = [['espada', 'sword']];
            }
            preload() {
                this.load.image('exclamation', 'images/exclamation.png');
                this.load.spritesheet('idle', 'images/main_character/idle.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('idle_mini_sword', 'images/main_character/idle_mini_sword.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('rocabrote', 'images/rocabrote.png', { frameWidth: 32, frameHeight: 50 });
                this.load.image('background', 'images/background.jpg');
                this.load.image('ground', 'images/ground.png');

                // this.load.image('rocabroteface', 'images/rocabroteface.png');
                // this.load.image('playerface', 'images/playerface.png');
                this.load.spritesheet('idle_spear', 'images/main_character/idle_spear.png', { frameWidth: 50, frameHeight: 32 });
                this.load.spritesheet('idle_mini_spear', 'images/main_character/idle_mini_spear.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('idle_bow', 'images/main_character/idle_bow.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('idle_shield', 'images/main_character/idle_shield.png', { frameWidth: 32, frameHeight: 32 });
                this.load.image('heart', 'images/heart.png');
                this.load.spritesheet('running', 'images/main_character/running.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('jumping', 'images/main_character/jumping.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('spear_running', 'images/main_character/spear_running.png', { frameWidth: 50, frameHeight: 32 });
                this.load.spritesheet('bow_running', 'images/main_character/bow_running.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('shield_running', 'images/main_character/shield_running.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('idle_mini_shield', 'images/main_character/idle_mini_shield.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('sword_attack_anim', 'images/main_character/sword_attack_anim.png', { frameWidth: 40, frameHeight: 32 });
                this.load.spritesheet('enemy_pig', 'images/enemy_pig.png', { frameWidth: 18, frameHeight: 18 });
                this.load.spritesheet('coin', 'images/miscellaneous/coin.png', { frameWidth: 18, frameHeight: 18 });

                this.load.spritesheet('single_lava_top', 'images/textures/single_lava.png', { frameWidth: 18, frameHeight: 18 });
                this.load.spritesheet('single_lava_middle', 'images/textures/single_lava_middle.png', { frameWidth: 18, frameHeight: 18 });

                this.load.image('single_platform', 'images/textures/single_platform.png');
                this.load.image('single_grass_full', 'images/textures/single_grass_full.png');
                this.load.image('single_grass_middle', 'images/textures/single_grass_middle.png');
                this.load.image('single_grass_left', 'images/textures/single_grass_left.png');
                this.load.image('single_grass_right', 'images/textures/single_grass_right.png');
                //  this.load.image('single_dirt_full', 'images/textures/single_dirt_full.png');
                this.load.image('single_dirt_middle', 'images/textures/single_dirt_middle.png');
                this.load.image('single_dirt_left', 'images/textures/single_dirt_left.png');
                this.load.image('single_dirt_right', 'images/textures/single_dirt_right.png');

                this.load.image('single_stone', 'images/textures/single_stone.png');
                this.load.image('single_brick', 'images/textures/single_brick.png');
                this.load.image('single_wood', 'images/textures/single_wood.png');

                //gadgets
                this.load.image('gancho', 'images/gadgets/grappling_hook.png');
                this.load.image('gancho_disparado', 'images/gadgets/grappling_hook_shot.png');
                this.load.image('garfio_gancho', 'images/gadgets/grappling_hook_proyectile.png');

                //armas
                this.load.image('espada', 'images/weapons/sword.png');
                this.load.image('escudo', 'images/weapons/shield.png');
                this.load.image('lanza', 'images/weapons/spear.png');
                this.load.image('arco', 'images/weapons/bow.png');
                this.load.image('arco_vacio', 'images/weapons/empty_bow.png');

                //items
                this.load.image('arrow', 'images/items/arrow.png');

                //hud
                this.load.image('espada_hud', 'images/hud/sword_hud.png');
                this.load.image('escudo_hud', 'images/hud/shield_hud.png');
                this.load.image('lanza_hud', 'images/hud/spear_hud.png');
                this.load.image('arco_hud', 'images/hud/bow_hud.png');
                this.load.image('arco_vacio_hud', 'images/hud/empty_bow_hud.png');
                this.load.image('gancho_hud', 'images/hud/grappling_hook_hud.png');
            }

            createAnimations() {
                this.anims.create({
                    key: 'rocabrote_anim',
                    frames: this.anims.generateFrameNumbers('rocabrote', { start: 0, end: -1 }),
                    frameRate: 3,
                    repeat: -1
                });
                this.anims.create({
                    key: 'idle_anim',
                    frames: this.anims.generateFrameNumbers('idle', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1,
                    origin: { x: 0.5, y: 0.5 }
                });

                this.anims.create({
                    key: 'spear_anim',
                    frames: this.anims.generateFrameNumbers('idle_spear', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'idle_mini_spear_anim',
                    frames: this.anims.generateFrameNumbers('idle_mini_spear', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'bow_anim',
                    frames: this.anims.generateFrameNumbers('idle_bow', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'shield_anim',
                    frames: this.anims.generateFrameNumbers('idle_shield', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'running_anim',
                    frames: this.anims.generateFrameNumbers('running', { start: 0, end: -1 }),
                    frameRate: 2,
                    repeat: -1
                });

                this.anims.create({
                    key: 'jumping_anim',
                    frames: this.anims.generateFrameNumbers('jumping', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'spear_running_anim',
                    frames: this.anims.generateFrameNumbers('spear_running', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'bow_running_anim',
                    frames: this.anims.generateFrameNumbers('bow_running', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'shield_running_anim',
                    frames: this.anims.generateFrameNumbers('shield_running', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'idle_mini_sword_anim',
                    frames: this.anims.generateFrameNumbers('idle_mini_sword', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'idle_mini_shield_anim',
                    frames: this.anims.generateFrameNumbers('idle_mini_shield', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });

                this.anims.create({
                    key: 'sword_attack_anim',
                    frames: this.anims.generateFrameNumbers('sword_attack_anim', { start: 0, end: 3 }),
                    frameRate: 10,
                    repeat: 0
                });

            }




            createScenario() {
                const graphics = this.add.graphics();
                graphics.fillStyle(0x0000ff, 1);
                graphics.fillStyle(0x87CEEB, 1);
                graphics.fillRect(-2000, -10000, 15000, 15000);

                this.leftWall = this.physics.add.staticGroup();
                this.leftWall.create(-100, window.innerHeight / 2, 'ground').setScale(0.1, window.innerHeight).refreshBody();
                this.leftWall.setVisible(false);

                this.platforms = [];

                //castillico porque para nada esto es un plagio clarísimo a cierto juego de Nintendo
                Utils.rectangle(this, 'single_brick', -24, 6, 1, 1);
                Utils.rectangle(this, 'single_brick', -22, 6, 1, 1);
                Utils.rectangle(this, 'single_brick', -20, 6, 1, 1);
                Utils.rectangle(this, 'single_brick', -18, 6, 1, 1);
                Utils.rectangle(this, 'single_brick', -24, 5, 3, 7);
                Utils.rectangle(this, 'single_brick', -24, 5, 3, 7);
                Utils.rectangle(this, 'single_brick', -20, 2, 2, 3);
                Utils.rectangle(this, 'single_brick', -24, 2, 2, 3);
                //generación de todo el mapa
                Utils.staircase(this, 'single_platform', 3, 1, 5, 1, false);
                this.lavaGroup = this.physics.add.staticGroup();
                Utils.lava(this, 8, -9, 10, 3);
                Utils.staircase(this, 'single_platform', 10, 1, 5, 1, true);
                Utils.rectangle(this, 'single_platform', 15, 7, 1, 2);
                Utils.rectangle(this, 'single_platform', 20, 9, 1, 2);
                Utils.rectangle(this, 'single_platform', 25, 11, 1, 2);
                Utils.rectangle(this, 'single_platform', 37, 7, 1, 6);
                Utils.grass(this, -100, -20, 21, 108);
                Utils.grass(this, 11, -20, 21, 10);
                Utils.grass(this, 19, -22, 24, 10);
                Utils.grass(this, 32, -22, 24, 3);
                Utils.grass(this, 32, -22, 25, 3);
                Utils.grass(this, 38, -26, 21, 3);
                Utils.rectangle(this, 'single_stone', 40, -1, 1, 3);
                Utils.grass(this, 40, 0, 2, 3);
                Utils.rectangle(this, 'single_platform', 48, -3, 1, 6);

                Utils.grass(this, 54, -22, 19, 10);
                Utils.rectangle(this, 'single_platform', 64, -3, 1, 6);
                Utils.rectangle(this, 'single_platform', 75, -1, 1, 10);
                Utils.rectangle(this, 'single_platform', 79, 7, 8, 2);
                Utils.rectangle(this, 'single_platform', 70, -4, 1, 1);
                Utils.rectangle(this, 'single_platform', 71, -5, 1, 2);
                Utils.rectangle(this, 'single_platform', 73, -6, 1, 4);
                Utils.rectangle(this, 'single_platform', 77, -7, 1, 6);
                Utils.rectangle(this, 'single_platform', 83, -6, 1, 4);
                Utils.rectangle(this, 'single_platform', 87, -5, 1, 2);
                Utils.rectangle(this, 'single_platform', 89, -4, 1, 1);
                Utils.rectangle(this, 'single_platform', 90, -3, 1, 6);

                Utils.rectangle(this, 'single_platform', 50, 5, 3, 2);
                Utils.rectangle(this, 'single_platform', 55, 8, 2, 4);
                Utils.staircase(this, 'single_platform', 60, 1, 7, 1, false);
                Utils.rectangle(this, 'single_platform', 70, 10, 1, 3);
                Utils.rectangle(this, 'single_platform', 75, 12, 1, 2);
                Utils.rectangle(this, 'single_platform', 80, 14, 1, 1);
                Utils.rectangle(this, 'single_platform', 85, 16, 1, 1);
                Utils.rectangle(this, 'single_platform', 90, 18, 1, 1);
                Utils.rectangle(this, 'single_platform', 95, 20, 1, 1);
                Utils.rectangle(this, 'single_platform', 100, 22, 1, 1);
                Utils.rectangle(this, 'single_platform', 105, 24, 1, 1);
                Utils.rectangle(this, 'single_platform', 110, 26, 1, 1);
                Utils.rectangle(this, 'single_platform', 115, 28, 1, 1);
                Utils.rectangle(this, 'single_platform', 120, 30, 1, 1);
                Utils.rectangle(this, 'single_platform', 125, 32, 1, 1);
                Utils.rectangle(this, 'single_platform', 130, 34, 1, 1);
                Utils.rectangle(this, 'single_platform', 135, 36, 1, 1);
                Utils.rectangle(this, 'single_platform', 140, 38, 1, 1);
            }


            createWeapons() {
                const gancho = this.physics.add.image(this.main_character.x + 26, this.main_character.y, 'gancho').setScale(2).setVisible(false);
                this.gancho = gancho;
                this.gancho.setDepth(1);
                this.gancho.body.setAllowGravity(false);
                this.gancho.setImmovable(true);

                const espada = this.physics.add.image(this.main_character.x + 26, this.main_character.y, 'espada').setScale(2).setVisible(false);
                this.espada = espada;
                this.espada.setDepth(1);
                this.espada.body.setAllowGravity(false);
                this.espada.setImmovable(true);

                const lanza = this.physics.add.image(this.main_character.x + 26, this.main_character.y, 'lanza').setScale(5).setVisible(false);
                this.lanza = lanza;
                this.lanza.setDepth(1);
                this.lanza.body.setAllowGravity(false);
                this.lanza.setImmovable(true);

                const escudo = this.physics.add.image(this.main_character.x + 26, this.main_character.y, 'escudo').setScale(2).setVisible(false);
                this.escudo = escudo;
                this.escudo.setDepth(1);
                this.escudo.body.setAllowGravity(false);
                this.escudo.setImmovable(true);

                const arco = this.physics.add.image(this.main_character.x + 26, this.main_character.y, 'arco').setScale(3).setVisible(false);
                this.arco = arco;
                this.arco.setDepth(1);
                this.arco.body.setAllowGravity(false);
                this.arco.setImmovable(true);
                this.currentWeapon = this.espada;
                this.changeWeapon('espada', 'sword');
                this.changeWeapon('espada', 'sword');


            }

            createAssets() {
                const exclamation = this.add.sprite(0, 0, 'exclamation').setVisible(false);
                this.exclamation = exclamation;

                const main_character = this.physics.add.sprite(500, window.innerHeight - 100, 'idle');
                const rocabrote = this.physics.add.sprite(500 + 54 * 26, window.innerHeight - 54 * 20, 'rocabrote');

                main_character.setScale(2.5);
                main_character.setOrigin(0.5, 0.5);
                this.physics.add.collider(main_character, this.leftWall);
                this.platforms.forEach(platform => {
                    this.physics.add.collider(main_character, platform);
                });
                rocabrote.setScale(2.5);
                exclamation.setScale(0.1);


                rocabrote.play('rocabrote_anim');
                this.main_character = main_character;
                this.weaponX = 26;
                this.main_character.play('idle_anim');
                this.rocabrote = rocabrote;
                this.platforms.forEach(platform => {
                    this.physics.add.collider(this.rocabrote, platform);
                });
                this.main_character.setDepth(1);

                this.enemies_pig = [];
                this.coins = [];
                EnemyUtils.pig(this, 500 + 54 * 18, window.innerHeight - 54);
                EnemyUtils.pig(this, 500 + 54 * 56, window.innerHeight - 54);


                const coinIcon = this.add.image(30, 70, 'coin', 0).setScale(2).setOrigin(0.5, 0.5);
                coinIcon.setScrollFactor(0);

                const coinText = this.add.text(60, 60, `x${this.coinCount}`, {
                    fontSize: '24px',
                    fontFamily: '"Press Start 2P"',
                    fill: '#ffffff'
                }).setOrigin(0, 0.25);

                coinText.setScrollFactor(0);
                this.coinText = coinText;

                this.coins.forEach(coin => {
                    coin.body.setAllowGravity(false);
                    coin.body.setImmovable(true);
                });

                this.physics.add.overlap(this.main_character, this.coins, (main_character, coin) => {
                    coin.destroy();
                    this.coinCount += 1;
                    this.coinText.setText(`x${this.coinCount}`);
                });



                Moneda.moneda(this, 15, 7);
                Moneda.moneda(this, 16, 7);
                Moneda.moneda(this, 20, 9);
                Moneda.moneda(this, 21, 9);
                Moneda.moneda(this, 37, 7);
                Moneda.moneda(this, 38, 7);
                Moneda.moneda(this, 39, 7);
                Moneda.moneda(this, 40, 7);
                Moneda.moneda(this, 41, 7);
                Moneda.moneda(this, 42, 7);

            }

            createHitBoxes() {
                if (!this.inAction) {
                    this.physics.add.overlap(this.main_character, this.rocabrote, this.showExclamation, null, this);
                } else {
                    this.exclamation.setVisible(false);
                }

                this.platforms.forEach(platform => {
                    this.physics.add.collider(this.main_character, platform);
                });

                this.physics.add.overlap(this.main_character, this.lavaGroup, this.touchLava, null, this);

            }

            touchLava() {
                if (!this.invincible) {
                    this.isBurning = true;
                    this.loseLife(1);
                    this.main_character.setVelocityY(-this.speed * 2.5);
                }
            }

            showExclamation() {
                this.exclamation.setPosition(this.rocabrote.x, this.rocabrote.y - this.rocabrote.height * 1.5);
                this.exclamation.setVisible(true);
                this.action = true;
            }

            hideExclamation() {
                if (Phaser.Math.Distance.Between(this.main_character.x, this.main_character.y, this.rocabrote.x, this.rocabrote.y) > 50) {
                    this.exclamation.setVisible(false);
                    this.action = false;
                }
            }

            controlWeaponState() {
                switch (this.weapon) {
                    case 'sword':
                        this.isAttacking = this.input.activePointer.isDown;

                        if (this.isAttacking) {
                            this.weaponX = this.main_character.flipX ? -40 : 40;
                            this.weaponOverlap = this.physics.add.overlap(
                                this.currentWeapon,
                                this.enemies_pig,
                                (weapon, enemy) => {
                                    enemy.getHit(2);
                                },
                                null,
                                this
                            );

                        }

                        else {
                            this.weaponX = this.main_character.flipX ? -20 : 20;
                            if (this.weaponOverlap) {
                                this.physics.world.removeCollider(this.weaponOverlap);
                            }
                        }
                        break;
                    case 'shield':
                        this.isDefending = this.input.activePointer.isDown;
                        if (this.isDefending) {
                            this.main_character.setVelocityX(0);
                            this.weaponX = this.main_character.flipX ? -40 : 40;
                            this.currentWeapon.setScale(2.5);
                        }

                        else {
                            this.weaponX = this.main_character.flipX ? -20 : 20;
                            this.currentWeapon.setScale(2);
                        }

                        break;
                    case 'spear':
                        this.isAttacking = this.input.activePointer.isDown;

                        if (this.isAttacking) {
                            this.weaponX = this.main_character.flipX ? -50 : 50;
                            this.weaponOverlap = this.physics.add.overlap(
                                this.currentWeapon,
                                this.enemies_pig,
                                (weapon, enemy) => {
                                    enemy.getHit(1);
                                },
                                null,
                                this
                            );

                        }

                        else {
                            this.weaponX = this.main_character.flipX ? -20 : 20;
                            if (this.weaponOverlap) {
                                this.physics.world.removeCollider(this.weaponOverlap);
                            }
                        }

                        break;
                    case 'bow':
                        this.isAttacking = this.input.activePointer.isDown;
                        if (this.isAttacking && !this.arrowCooldown) {
                            this.throwArrow();
                        }
                        break;

                    case 'grappling_hook':
                        this.isAttacking = this.input.activePointer.isDown;
                        if (this.isAttacking) {
                            this.grapplingHook();
                        }
                        break;
                }
            }

            grapplingHook() {
                if (!this.ganchoShot) {

                    this.main_character.body.allowGravity = false;
                    this.main_character.setVelocityX(0);
                    this.main_character.setVelocityY(0);

                    this.inAction = true;

                    this.ganchoShot = true;
                    this.gancho.setTexture('gancho_disparado');
                    const grapplingHookProjectile = this.physics.add.image(this.main_character.x + this.weaponX, this.main_character.y + 17, 'garfio_gancho').setScale(2);
                    grapplingHookProjectile.setVelocityX(this.main_character.flipX ? -1000 : 1000);
                    grapplingHookProjectile.flipX = this.main_character.flipX;
                    grapplingHookProjectile.body.allowGravity = false;

                    const line = this.add.graphics();
                    line.lineStyle(2, 0x000000, 1);
                    line.moveTo(this.currentWeapon.x, this.currentWeapon.y);
                    line.lineTo(grapplingHookProjectile.x, grapplingHookProjectile.y);
                    line.strokePath();

                    const tweenConfig = {
                        targets: grapplingHookProjectile,
                        x: this.currentWeapon.x,
                        y: this.currentWeapon.y,
                        duration: 350,
                        onComplete: () => {
                            line.destroy();
                            grapplingHookProjectile.destroy();
                            this.gancho.setTexture('gancho');
                            this.grapplingHookHit = false;
                            this.inAction = false;
                            this.main_character.body.allowGravity = true;
                            this.ganchoShot = false;
                        }
                    };

                    this.time.addEvent({
                        delay: 10,
                        callback: () => {
                            line.clear();
                            line.lineStyle(2, 0x000000, 1);
                            line.moveTo(this.currentWeapon.x, this.currentWeapon.y - 3);
                            line.lineTo(grapplingHookProjectile.x, grapplingHookProjectile.y);
                            line.strokePath();
                        },
                        loop: true
                    });

                    this.main_character.body.allowGravity = false;

                    this.physics.add.collider(grapplingHookProjectile, this.enemies_pig, (projectile, enemy) => {
                        this.tweens.add(tweenConfig);
                        enemy.getHit(1);
                    }, null, this);

                    this.physics.add.collider(grapplingHookProjectile, this.platforms, (projectile, platform) => {
                        this.grapplingHookHit = true;
                        if (platform.texture.key != 'single_wood') {
                            this.tweens.add(tweenConfig);
                            return;
                        }
                        const velocity = this.main_character.flipX ? -1000 : 1000;
                        this.main_character.setVelocityX(velocity);


                        if (this.main_character.flipX) {
                            this.main_character.setAngle(-90);
                        } else {
                            this.main_character.setAngle(90);
                        }

                        projectile.setVelocityX(0);
                        this.time.delayedCall(500, () => {
                            this.main_character.body.allowGravity = true;
                            this.inAction = false;
                            this.main_character.setAngle(0);
                            projectile.destroy();
                            line.destroy();
                            this.ganchoShot = false;
                            this.gancho.setTexture('gancho');
                            this.grapplingHookHit = false;
                        }, null, this);

                    });

                    this.time.delayedCall(500, () => {
                        if (!this.grapplingHookHit) {
                            this.tweens.add(tweenConfig);
                        }
                    }, null, this);
                }
            }

            throwArrow() {
                if (this.arrows > 0) {
                    this.arrows--;
                    this.arrowCooldown = true;
                    const arrow = this.physics.add.image(this.main_character.x + this.weaponX, this.main_character.y + 20, 'arrow').setScale(3);
                    arrow.setVelocityX(this.main_character.flipX ? -500 : 500);
                    arrow.flipX = this.main_character.flipX;
                    arrow.body.allowGravity = false;
                    this.physics.add.collider(arrow, this.enemies_pig, (arrow, enemy) => {
                        enemy.getHit(3);
                        arrow.destroy();
                    });

                    this.physics.add.collider(arrow, this.platforms, (arrow, platform) => {
                        arrow.setVelocityX(0);
                        this.time.delayedCall(10000, () => {
                            arrow.destroy();
                        }, null, null);
                    });

                    this.time.delayedCall(2000, () => {
                        this.arrowCooldown = false;
                    }, null, null);

                    if (this.arrows == 0) {
                        this.arco.setTexture('arco_vacio');
                        this.weaponIcon.setTexture('arco_vacio_hud');
                    }

                    return;
                }


            }

            changeWeapon(weapon, weaponName) {
                this.currentWeapon.setVisible(false);
                this.currentWeapon = this[weapon];
                this.currentWeapon.flipX = this.main_character.flipX;
                this.currentWeapon.setVisible(true);
                this.weapon = weaponName;

                if (this.weaponIcon) {
                    this.weaponIcon.destroy();
                }
                const weaponIcon = this.add.image(window.innerWidth - 75, 75, weapon + '_hud').setScale(6).setOrigin(0.5, 0.5);
                weaponIcon.setScrollFactor(0);
                this.weaponIcon = weaponIcon;

                if (this.weapon == 'bow' && this.arrows > 0) {
                    this.arco.setTexture('arco');
                    this.weaponIcon.setTexture('arco_hud');
                }

                else if (this.weapon === 'bow' && this.arrows <= 0) {
                    this.arco.setTexture('arco_vacio');
                    this.weaponIcon.setTexture('arco_vacio_hud');
                }
            }

            switchWeapon(index) {
                index += 1;
                if (index > 0 && index <= this.weapons.length) {
                    this.weaponIndex = index;
                    this.changeWeapon(this.weapons[index - 1][0], this.weapons[index - 1][1]);
                }
            }

            create() {
                this.createScenario();
                this.createAnimations();
                this.createAssets();
                this.createWeapons();
                this.createHitBoxes();
                this.cursors = this.input.keyboard.createCursorKeys();

                const heartSpacing = 50;
                for (let i = 0; i < this.lives; i++) {
                    const heart = this.add.image(30 + i * heartSpacing, 30, 'heart').setScale(0.05).setOrigin(0.5, 0.5);
                    heart.setScrollFactor(0);
                    this.hearts.push(heart);
                }

                this.tweens.add({
                    targets: this.hearts[this.lives - 1],
                    scale: { from: 0.05, to: 0.06 },
                    duration: 150 * this.lives,
                    yoyo: true,
                    repeat: -1
                });

                this.cameras.main.startFollow(this.main_character, true, 0.05, 0.05);
                this.physics.world.setBounds(0, 0, 2000, window.innerHeight);
            }

            //función obsoleta por ahora
            reloadHearts() {
                this.hearts.forEach(heart => heart.destroy());
                this.hearts = [];
                const heartSpacing = 50;
                for (let i = 0; i < this.lives; i++) {
                    const heart = this.add.image(30 + i * heartSpacing, 30, 'heart').setScale(0.05).setOrigin(0.5, 0.5);
                    this.hearts.push(heart);
                }
            }

            animateHearts() {
                let heartSpeed = 150 * this.lives;

                this.tweens.add({
                    targets: this.hearts[this.lives - 1],
                    scale: { from: 0.05, to: 0.06 },
                    duration: heartSpeed,
                    yoyo: true,
                    repeat: -1
                });
            }

            loseLife(lifes) {
                if (this.lives > 0) {

                    for (let i = 0; i < lifes; i++) {
                        const lostHeart = this.hearts.pop();
                        lostHeart ? lostHeart.destroy() : null;
                    }

                    this.lives -= lifes;

                    if (this.lives <= 0) {
                        this.gameOver();
                        return;
                    }

                    this.invincible = true;

                    if (this.isBurning) {
                        this.isBurning = false;
                        this.main_character.setTint(0xff0000);
                        this.currentWeapon.setTint(0xff0000);


                        this.time.delayedCall(1500, () => {
                            this.main_character.clearTint();
                            this.currentWeapon.clearTint();
                            this.invincible = false;
                        }, [], this);

                        return;
                    }

                    this.time.addEvent({
                        delay: 100,
                        repeat: 15,
                        callback: () => {
                            this.main_character.setVisible(!this.main_character.visible);
                        }
                    });


                    this.time.delayedCall(1500, () => {
                        this.invincible = false;
                    }, [], this);

                    this.animateHearts();

                }
            }

            gameOver() {
                const gameOverText = this.add.text(this.cameras.main.scrollX + window.innerWidth / 2, this.cameras.main.scrollY + window.innerHeight / 2, 'Game Over', {
                    fontSize: '64px',
                    fontFamily: '"Press Start 2P"',
                    fill: '#ff0000',
                    stroke: '#000000',
                    strokeThickness: 8,
                    shadow: {
                        offsetX: 5,
                        offsetY: 5,
                        color: '#000000',
                        blur: 10,
                        stroke: true,
                        fill: true
                    }
                }).setOrigin(0.5);
                gameOverText.setDepth(1000);
                this.tweens.add({
                    targets: gameOverText,
                    scale: { from: 1, to: 1.2 },
                    duration: 500,
                    yoyo: true,
                    repeat: -1
                });
                this.scene.pause();
            }


            enableDragAndDrop() {
                if (this.optionTexts) {
                    this.optionTexts.forEach(optionText => {
                        optionText.removeAllListeners();
                        optionText.destroy();
                    });
                }

                this.input.off('drop');
                this.input.off('drag');
                this.input.off('dragstart');
                this.input.off('dragend');
                this.optionTexts = [];
                this.options.forEach((opt, idx) => {
                    const optionText = this.add.text(
                        this.cameras.main.scrollX + (window.innerWidth / (this.options.length + 1)) * (idx + 1),
                        this.cameras.main.scrollY + window.innerHeight - 100,
                        opt,
                        { font: '16px', fontFamily: '"Press Start 2P"', fill: '#000000', backgroundColor: '#ffffff', padding: { x: 10, y: 5 } }
                    ).setOrigin(0.5).setInteractive();


                    this.input.setDraggable(optionText);
                    this.optionTexts.push(optionText);

                    optionText.on('dragstart', (pointer, dragX, dragY) => {
                        optionText.setAlpha(0.5);
                    });

                    optionText.on('drag', (pointer, dragX, dragY) => {
                        optionText.x = dragX;
                        optionText.y = dragY;
                    });

                    optionText.on('dragend', (pointer, dragX, dragY, dropped) => {
                        if (!dropped) {
                            optionText.setAlpha(1);
                            optionText.x = this.cameras.main.scrollX + (window.innerWidth / (this.options.length + 1)) * (idx + 1);
                            optionText.y = this.cameras.main.scrollY + window.innerHeight - 100;
                        }
                    });
                });
                const dropZone = this.add.zone(
                    this.rocabrote.x,
                    this.rocabrote.y + this.rocabrote.height * 0.3,
                    window.innerWidth - 40,
                    200
                ).setRectangleDropZone(window.innerWidth - 600, 280);

                this.input.on('drop', (pointer, gameObject) => {
                    const selectedOption = gameObject.text;
                    gameObject.destroy();

                    switch (selectedOption) {
                        case '¿Quién eres?':
                            this.rocabroteText = 'Soy Rocabrote, el guardián de este lugar.';
                            this.options = ['¿Cuál es tu misión?', '¿Cómo llegaste aquí?'];
                            break;
                        case '¿Dónde estoy?':
                            this.rocabroteText = 'Estás en Arvandor, un lugar místico y antiguo.';
                            this.options = ['¿Qué puedo hacer aquí?', '¿Es peligroso?'];
                            break;
                        case '¿Qué haces aquí?':
                            this.rocabroteText = 'Estoy aquí para guiar a los viajeros como tú.';
                            this.options = ['¿Cómo me puedes ayudar?', '¿Qué debo hacer ahora?'];
                            break;
                        case '¿Cuál es tu misión?':
                            this.rocabroteText = 'Mi misión es proteger este lugar de los intrusos.';
                            this.options = ['¿Cómo llegaste aquí?', '¿Qué debo hacer ahora?'];
                            break;
                        case '¿Cómo llegaste aquí?':
                            this.rocabroteText = 'Llegué aquí hace muchos años, guiado por una visión.';
                            this.options = ['¿Qué visión?', '¿Qué debo hacer ahora?'];
                            break;
                        case '¿Qué puedo hacer aquí?':
                            this.rocabroteText = 'Puedes explorar, aprender y ayudar a proteger este lugar.';
                            this.options = ['¿Cómo puedo ayudar?', '¿Es peligroso?'];
                            break;
                        case '¿Es peligroso?':
                            this.rocabroteText = 'Puede serlo, pero con cuidado y sabiduría, estarás a salvo.';
                            this.options = ['¿Cómo puedo estar seguro?', '¿Qué debo hacer ahora?', 'Pedazo de cursilada de texto'];
                            break;

                        case 'Pedazo de cursilada de texto':
                            this.rocabroteText = 'No sé qué decirte, viajero. ¿Necesitas algo más?';
                            this.options = ['¿Eres consciente de que estamos en un juego?', 'Cuéntame más sobre Arvandor', 'Salir'];
                            break;

                        case '¿Eres consciente de que estamos en un juego?':
                            this.glitch++;

                            if (this.glitch > 3) {
                                this.glitched = true;
                                this.rocabrote.y -= this.rocabrote.height * 2;
                                this.rocabrote.setScale(20);
                                this.rocabroteTextBox.setStyle({
                                    backgroundColor: '#000000',
                                    fill: '#ffffff'
                                });

                                this.cameras.main.shake(200, 0.02, true).on('camerashakecomplete', () => {
                                    if (this.inAction) {
                                        this.cameras.main.flash(500, 255, 0, 0, true).on('cameraflashcomplete', () => {
                                            this.cameras.main.shake(200, 0.02, true);
                                        });
                                    }
                                });

                                this.rocabroteText = 'OAWIJDOIAHDOPIABUABIUBWAIUGFIUOABIUCBIUAWDADUASIDAIPWDGA';
                                this.options = ['???', '???', '???'];
                            } else {
                                this.rocabroteText = 'No sé de qué hablas, viajero. ¿Necesitas algo más?';
                                this.options = ['¿Eres consciente de que estamos en un juego?', 'Cuéntame más sobre Arvandor', 'Salir'];
                            }
                            break;

                        case '???':
                            this.rocabroteText = '?¿!")!)=i?js=)=)jhs=)h!=u=u@#|#DAgdygdiuagidw9dUDAHDUHADDA';
                            this.options = ['Ni siquiera tengo esto programado'];

                            break;

                        case 'Ni siquiera tengo esto programado':
                            this.rocabroteText = '¿QUÉ ME HAS HECHO?';
                            this.options = ['No lo sé', 'Salir'];
                            break;

                        case 'No lo sé':
                            this.rocabroteText = '¿QUÉ ME HAS...?';
                            this.options = ['...', 'Salir'];
                            break;

                        case '...':
                            this.rocabroteText = '¿QUÉ ME HAS...?';
                            this.options = ['...', 'Salir'];
                            break;
                        case '¿Cómo me puedes ayudar?':
                            this.rocabroteText = 'Puedo darte consejos y guiarte en tu viaje.';
                            this.options = ['¿Qué consejos tienes?', '¿Qué debo hacer ahora?'];
                            break;
                        case '¿Qué debo hacer ahora?':
                            this.rocabroteText = 'Sigue tu corazón y busca la verdad en todo lo que encuentres.';
                            this.options = ['Gracias', 'Adiós'];
                            break;
                        case '¿Qué visión?':
                            this.rocabroteText = 'Una visión de paz y protección para este lugar sagrado.';
                            this.options = ['¿Cómo puedo ayudar?', '¿Qué debo hacer ahora?'];
                            break;
                        case '¿Cómo puedo ayudar?':
                            this.rocabroteText = 'Ayuda a mantener la paz y protege a los inocentes.';
                            this.options = ['¿Qué debo hacer ahora?', 'Gracias'];
                            break;
                        case '¿Cómo puedo estar seguro?':
                            this.rocabroteText = 'Aún viendo tu potencial, con ese arma no llegarás lejos.';
                            this.options = ['Mi espada es más que suficiente', '¿Tienes algo para mí?'];
                            break;
                        case '¿Qué consejos tienes?':
                            this.rocabroteText = 'Pareces fuerte, pero no llegarás muy lejos sin una buena arma.';
                            this.options = ['¿Tienes algo para mí?', 'Mi espada es más que suficiente'];
                            break;
                        case 'Mi espada es más que suficiente':
                            this.rocabroteText = 'No subestimes a tus enemigos, viajero. La sabiduría es tu mejor arma.';
                            this.options = ['¿Qué debo hacer ahora?', 'Prefiero otro arma', 'Gracias'];
                            break;
                        case '¿Tienes algo para mí?':
                            this.rocabroteText = 'A juzgar por tu mirada, necesitas algo más que una espada. Adelante, te doy a elegir.';
                            this.options = ['Lanza', 'Escudo', 'Arco'];

                            if (this.coinCount >= 10) {
                                this.options.push('Gancho (10 monedas)');
                            }
                            break;
                        case 'Lanza':
                            this.rocabroteText = 'Con esta lanza podrás atacar a tus enemigos con mayor alcance. Buena elección.';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['lanza', 'spear']);
                            this.changeWeapon('lanza', 'spear');
                            console.log(this.weapons);

                            break;
                        case 'Escudo':
                            this.rocabroteText = 'Con este escudo podrás protegerte de los ataques enemigos. Te irá bien en tu viaje.';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['escudo', 'shield']);
                            this.changeWeapon('escudo', 'shield');

                            break;
                        case 'Arco':
                            this.rocabroteText = 'Con este arco podrás atacar a tus enemigos desde la distancia. Buena elección.';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['arco', 'bow']);
                            this.changeWeapon('arco', 'bow');


                            break;

                        case 'Gancho (10 monedas)':
                            this.rocabroteText = 'Con este gancho podrás llegar a lugares inaccesibles. Buena elección.';
                            this.coinCount -= 10;
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['gancho', 'grappling_hook']);
                            this.changeWeapon('gancho', 'grappling_hook');

                            break;
                        case 'Gracias':
                            this.rocabroteText = 'De nada, viajero. Que tengas un buen viaje.';
                            this.options = ['Adiós'];
                            break;
                        case 'Adiós':
                            this.rocabroteText = 'Adiós, viajero. Que encuentres lo que buscas.';
                            this.options = ['Salir'];
                            break;
                        case 'Salir':

                            if (this.glitched) {
                                this.rocabrote.setScale(1);
                                this.rocabroteText = 'Ahora soy minúsculo, estarás contento, ¿no?';
                                this.options = ['¿Me puedes dar algún arma?', 'Salir'];

                            }

                            else {
                                this.rocabroteText = '¿Necesitas algo más?';
                                this.options = ['Prefiero otro arma', 'Cuéntame más sobre Arvandor', 'Salir'];
                            }

                            this.endConversation();
                            return;
                            break;

                        case '¿Me puedes dar algún arma?':
                            this.rocabroteText = '¡Claro! ¿Te refieres a las armas que has encogido por romper el juego? ¡Elige!';
                            this.options = ['Mini lanza', 'Mini arco', 'Mini escudo', 'Mejor me quedo con mi espada'];
                            break;

                        case 'Mejor me quedo con mi espada':
                            this.rocabroteText = '¡Ni de coña! ¡Ahora eliges!';
                            this.options = ['Mini lanza', 'Mini arco', 'Mini escudo', '¿Puedes encoger mi espada?'];
                            break;

                        case 'Mini lanza':
                            this.rocabroteText = '¡Aquí tienes tu mini lanza! ¡Que te sea útil!';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['mini_lanza', 'mini_spear']);
                            this.changeWeapon('mini_lanza', 'mini_spear');


                            break;

                        case 'Mini arco':
                            this.rocabroteText = '¡Aquí tienes tu mini arco! ¡Que te sea útil!';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['mini_arco', 'mini_bow']);
                            this.changeWeapon('mini_arco', 'mini_bow');


                            break;

                        case 'Mini escudo':
                            this.rocabroteText = '¡Aquí tienes tu mini escudo! ¡Que te sea útil!';
                            this.options = ['Esto no es Fortnite', '¿Gracias?'];
                            this.weapons.push(['mini_escudo', 'mini_shield']);
                            this.changeWeapon('mini_escudo', 'mini_shield');

                            break;

                        case '¿Puedes encoger mi espada?':
                            this.rocabroteText = '¡Pues claro! De lo contrario, el creador del juego no habría puesto esta opción.';
                            this.options = ['Gracias', 'Adiós'];
                            this.weapons.push(['mini_espada', 'mini_sword']);
                            this.changeWeapon('mini_espada', 'mini_sword');
                            break;

                        case 'Esto no es Fortnite':
                            this.rocabroteText = '¡Pues vaya! ¡Aquí tienes tu mini escudo! ¡Que te sea útil!';
                            this.options = ['Gracias', 'Adiós'];
                            break;

                        case '¿Gracias?':
                            this.rocabroteText = '¡De nada! ¡Que te sea útil!';
                            this.options = ['Salir'];
                            break;

                        case 'Cuéntame más sobre Arvandor':
                            this.rocabroteText = 'Arvandor es un lugar mágico y antiguo, lleno de secretos y peligros.';
                            this.options = ['¿Es peligroso?', '¿Qué puedo hacer aquí?', 'Salir'];
                            break;

                        case 'Prefiero otro arma':
                            this.rocabroteText = 'Sin problema. ¿Qué prefieres?';
                            this.options = ['Lanza', 'Escudo', 'Arco', 'Con mi espada será suficiente'];
                            if (this.coinCount >= 10) {
                                this.options.push('Gancho (10 monedas)');
                            }
                            break;

                        case 'Con mi espada será suficiente':
                            this.rocabroteText = 'Como quieras, viajero. Que tengas un buen viaje.';
                            this.options = ['Salir'];
                            this.changeWeapon('idle');
                            this.weapon = 'sword';
                            break;
                        default:
                            this.rocabroteText = 'No entiendo tu pregunta.';
                            this.options = ['Volver a preguntar', 'Salir'];
                            break;
                    }

                    this.rocabroteTextBox.setText(this.rocabroteText);
                    dropZone.destroy();
                    console.log('hola');
                    this.enableDragAndDrop();

                });
            }

            startConversation() {
                this.inAction = true;
                this.exclamation.setVisible(false);
                const rocabroteTextBox = this.add.text(this.cameras.main.scrollX + window.innerWidth / 2, this.cameras.main.scrollY + window.innerHeight / 4, this.rocabroteText, {
                    font: '16px',
                    fontFamily: '"Press Start 2P"',
                    fill: '#000000',
                    backgroundColor: '#ffffff',
                    padding: { x: 20, y: 10 },
                    wordWrap: { width: window.innerWidth - 40 },
                    border: '2px solid #000000'
                }).setOrigin(0.5);

                this.rocabroteTextBox = rocabroteTextBox;
                this.enableDragAndDrop();
            }

            endConversation() {

                this.rocabroteTextBox.destroy();
                this.optionTexts.forEach(optionText => optionText.destroy());
                this.optionTexts = [];
                this.inAction = false;
            }

            pauseGame() {
                this.scene.launch('PauseScene');
                this.scene.pause(this.scene.key);
            }

            stopCharacter() {
                if (!this.inAction) {
                    this.main_character.setVelocityX(0);
                    if (this.isMoving) {
                        this.isMoving = false;
                    }

                    if (!this.inAir && this.main_character.anims.currentAnim.key !== 'idle_anim') {
                        this.main_character.play('idle_anim');
                    }
                }
            }

            run(direction) {
                if (direction === 'left') {
                    this.currentWeapon.flipX = true;
                    this.weaponX = -26;
                    this.main_character.setVelocityX(-this.speed);
                    this.main_character.flipX = true;
                } else {
                    this.currentWeapon.flipX = false;
                    this.weaponX = 26;
                    this.main_character.setVelocityX(this.speed);
                    this.main_character.flipX = false;
                }

                if (!this.inAir && this.main_character.anims.currentAnim.key !== 'running_anim') {
                    this.isMoving = true;
                    this.main_character.play('running_anim');
                }

            }

            jump() {
                this.main_character.setVelocityY(-this.speed * 1.5);
            }

            updateState() {
                if (this.main_character.y > 1500) {
                    this.input.keyboard.enabled = false;
                    this.input.mouse.enabled = false;
                    this.cameras.main.stopFollow();

                    this.time.delayedCall(1000, () => {
                        this.loseLife(1000);
                    });
                }

                if (this.main_character.body.touching.down) {
                    this.inAir = false;
                } else {
                    this.inAir = true;
                }

                if (this.inAir && this.main_character.anims.currentAnim.key !== 'jumping_anim') {
                    this.main_character.play('jumping_anim');
                }
            }

            update() {
                this.updateState();
                if ((this.cursors.left.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A).isDown) && !this.inAction) {
                    this.run('left');
                } else if ((this.cursors.right.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D).isDown) && !this.inAction) {
                    this.run('right');
                } else {
                    this.stopCharacter();
                }

                if ((this.cursors.up.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE).isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W).isDown) && this.main_character.body.touching.down && !this.inAction) {
                    this.jump();
                }

                if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER)) && this.action && !this.inAction) {
                    this.startConversation();
                    this.exclamation.setVisible(false);
                }

                if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC))) {
                    if (this.inAction) {
                        this.inAction = false;
                        this.rocabroteTextBox.destroy();
                        this.optionTexts.forEach(optionText => optionText.destroy());
                    } else {
                        this.pauseGame();
                    }
                }

                if (!this.inAction) {
                    this.controlWeaponState();
                }

                this.input.keyboard.on('keydown', (event) => {
                    const key = event.key;
                    if (key >= '1' && key <= `${this.weapons.length}` && !this.inAction) {
                        const weaponIndex = parseInt(key) - 1;
                        this.switchWeapon(weaponIndex);
                    }
                });


                this.hideExclamation();


                this.currentWeapon.setPosition(this.main_character.x + this.weaponX, this.main_character.y + 20);


                this.enemies_pig.forEach(enemyPig => {
                    if (enemyPig.active) {
                        enemyPig.update();
                    }
                });
            }
        }

        class PauseScene extends Phaser.Scene {
            constructor() {
                super({ key: 'PauseScene' });
            }

            create() {
                this.add.text(
                    window.innerWidth / 2,
                    window.innerHeight / 2,
                    'Pausa',
                    { font: '64px Arial', fill: '#ffffff' }
                ).setOrigin(0.5);
            }

            update() {
                if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC))) {
                    this.scene.resume('Arvandor');
                    this.scene.stop();
                }
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            scene: [Arvandor, PauseScene],
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 750 }
                }
            },
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            render: {
                pixelArt: true
            }
        };

        const game = new Phaser.Game(config);

    </script>
</body>

</html>