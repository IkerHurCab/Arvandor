<!DOCTYPE html>
<html>

<head>
    <title>Arvandor</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <meta charset="UTF-8">
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
</style>

<body>

    <script>


        class Arvandor extends Phaser.Scene {

            constructor() {
                super('Arvandor');
                this.currentIndex = 0;
                this.playerText = '';
                this.options = ['¿Quién eres?', '¿Dónde estoy?', '¿Qué haces aquí?'];
                this.inAction = false;
                this.action = false;
            }
            preload() {
                this.load.image('exclamation', 'images/exclamation.png');
                this.load.spritesheet('idle', 'images/idle.png', { frameWidth: 32, frameHeight: 32 });
                this.load.spritesheet('rocabrote', 'images/rocabrote.png', { frameWidth: 32, frameHeight: 50 });
                this.load.image('background', 'images/background.jpg');
                this.load.image('ground', 'images/ground.png');
                this.load.image('rocabroteface', 'images/rocabroteface.png');
                this.load.image('playerface', 'images/playerface.png');
            }

            createAnimations() {
                this.anims.create({
                    key: 'rocabrote_anim',
                    frames: this.anims.generateFrameNumbers('rocabrote', { start: 0, end: -1 }),
                    frameRate: 3,
                    repeat: -1
                });
                this.anims.create({
                    key: 'idle_anim',
                    frames: this.anims.generateFrameNumbers('idle', { start: 0, end: -1 }),
                    frameRate: 4,
                    repeat: -1
                });
            }

            createScenario() {
                this.add.image(0, 0, 'background').setOrigin(0, 0).setDisplaySize(window.innerWidth, window.innerHeight);

                this.platforms = this.physics.add.staticGroup();
                const groundWidth = this.textures.get('ground').getSourceImage().width;


                for (let i = 0; i < 5; i++) {
                    this.platforms.create(i * 425, window.innerHeight - 32, 'ground').setScale(0.5).refreshBody();
                }
            }

            createAssets(){
                const exclamation = this.add.sprite(0, 0, 'exclamation').setVisible(false);
                this.exclamation = exclamation;

                const main_character = this.physics.add.sprite(50, window.innerHeight - this.platforms.getChildren()[0].displayHeight, 'idle');
                const rocabrote = this.physics.add.sprite(window.innerWidth - 500, window.innerHeight - this.platforms.getChildren()[0].displayHeight - 25, 'rocabrote');

                const scaleFactor = window.innerHeight * 0.15 / main_character.height;
                const scaleFactorRocabrote = window.innerHeight * 0.2 / rocabrote.height;
                const exclamationScaleFactor = window.innerHeight / exclamation.height;

                main_character.setScale(scaleFactor);
                rocabrote.setScale(scaleFactorRocabrote);
                exclamation.setScale(exclamationScaleFactor / 17);

                main_character.setCollideWorldBounds(true);
                rocabrote.setCollideWorldBounds(true);

                rocabrote.play('rocabrote_anim');
                main_character.play('idle_anim');
                this.main_character = main_character;
                this.rocabrote = rocabrote;

                main_character.setDepth(1);
            }

            createHitBoxes(){
                this.physics.add.overlap(this.main_character, this.rocabrote, this.showExclamation, null, this);
                this.physics.add.collider(this.main_character, this.platforms);
                this.physics.add.collider(this.rocabrote, this.platforms);
            }

            showExclamation() {
                this.exclamation.setPosition(this.rocabrote.x, this.rocabrote.y - this.rocabrote.height * 1.7);
                this.exclamation.setVisible(true);
                this.action = true;
            }

            hideExclamation() {
                if (Phaser.Math.Distance.Between(this.main_character.x, this.main_character.y, this.rocabrote.x, this.rocabrote.y) > 50) {
                    this.exclamation.setVisible(false);
                    this.action = false;
                }
            }

            create() {
                this.createScenario();
                this.createAnimations();
                this.createAssets();
                this.createHitBoxes();
                this.cursors = this.input.keyboard.createCursorKeys();
            }

            startConversation() {
                this.inAction = true;
                this.dialogueIndex = 0;
                this.dialogueData = this.getDialogueData();
                this.showDialogue();
            }

            getDialogueData() {
                return {
                    npc: 'rocabroteface',
                    dialogues: [
                        {
                            text: 'Hola, viajero. ¿Qué te trae por aquí?',
                            options: ['¿Quién eres?', '¿Dónde estoy?', '¿Qué haces aquí?']
                        },
                        {
                            responses: {
                                '¿Quién eres?': {
                                    text: 'Soy Rocabrote, el guardián de Arvandor.',
                                    options: ['¿Cuál es tu misión?', '¿Qué es Arvandor?', '¿Puedo ayudarte en algo?']
                                },
                                '¿Dónde estoy?': {
                                    text: 'Estás en Arvandor, el reino de los elfos.',
                                    options: ['¿Cómo llegué aquí?', '¿Qué es Arvandor?', '¿Hay peligros aquí?']
                                },
                                '¿Qué haces aquí?': {
                                    text: 'Mi deber es proteger este reino.',
                                    options: ['¿De qué lo proteges?', '¿Puedo explorar el reino?', '¿Necesitas ayuda?']
                                }
                            }
                        },
                        {
                            responses: {
                                '¿Cuál es tu misión?': {
                                    text: 'Defender Arvandor de las fuerzas oscuras.',
                                    options: ['¿Cómo puedo ayudar?', '¿Dónde están esas fuerzas?', '¿Es peligroso aquí?']
                                },
                                '¿Qué es Arvandor?': {
                                    text: 'Es un lugar mágico lleno de vida y misterio.',
                                    options: ['¿Qué misterios?', '¿Puedo explorarlo?', '¿Hay otros como tú?']
                                },
                                '¿Puedo ayudarte en algo?': {
                                    text: 'Tu ayuda sería apreciada. Necesitamos recolectar cristales mágicos.',
                                    options: ['¿Dónde los encuentro?', '¿Para qué sirven?', 'Cuenta conmigo']
                                }
                            }
                        },
                        {
                            responses: {
                                '¿Cómo llegué aquí?': {
                                    text: 'Abriendo el juego. ¿No recuerdas?',
                                    options: ['Es verdad.', '¿Juego? ¿De qué hablas?', '¿Qué juego?']
                                },
                                '¿Qué es Arvandor?': {
                                    text: '',
                                    options: ['', '', '']
                                },
                                '¿Puedo ayudarte en algo?': {
                                    text: '',
                                    options: ['']
                                }
                            }
                        },
                        {
                            responses: {
                                'Es verdad.': {
                                    text: 'Me alegra que lo recuerdes. ¡Bienvenido de nuevo!',
                                    options: []
                                },
                                '¿Juego? ¿De qué hablas?': {
                                    text: 'Este mundo es más que un simple juego para algunos.',
                                    options: []
                                },
                                '¿Qué juego?': {
                                    text: 'El que estás jugando ahora mismo.',
                                    options: []
                                }
                            }
                        }
                    ]
                };
            }

            showDialogue() {
                const dialogue = this.dialogueData.dialogues[this.dialogueIndex];
                if (!dialogue) {
                    this.inAction = false;
                    return;
                }

                const chatElements = this.createChatElements(this.dialogueData.npc);
                const { chatBox, chatText, face: npcFace } = chatElements;

                this.animateText(chatText, dialogue.text, () => {
                    const optionElements = this.createOptions(chatBox, dialogue.options);
                    this.setupOptionInteraction(optionElements, chatBox, chatText, npcFace, chatElements);
                });
            }

            createChatElements(faceKey) {
                const chatBox = this.add.rectangle(window.innerWidth * 0.5, window.innerHeight * 0.12,
                    window.innerWidth * 0.9, window.innerHeight * 0.1, 0xffffff).setOrigin(0.5);
                chatBox.setStrokeStyle(2, 0x000000);
                const face = this.add.image(chatBox.x - chatBox.width / 2 + 40, chatBox.y, faceKey).setOrigin(0.5);
                const faceScaleFactor = (chatBox.height * 0.8) / face.height;
                face.setScale(faceScaleFactor);
                const chatText = this.add.text(chatBox.x, chatBox.y, '', {
                    fontSize: '16px',
                    color: '#000000',
                    wordWrap: { width: chatBox.width - 10 }
                }).setOrigin(0.5);
                return { chatBox, face, chatText };
            }

            animateText(chatText, text, callback) {
                for (let i = 0; i < text.length; i++) {
                    this.time.addEvent({
                        delay: 50 * i,
                        callback: () => {
                            chatText.text += text[i];
                            if (i === text.length - 1 && callback) {
                                callback();
                            }
                        }
                    });
                }
            }

            createOptions(chatBox, options) {
                const optionElements = [];
                options.forEach((option, index) => {
                    const optionElement = this.add.text(chatBox.x, chatBox.y + chatBox.height / 2 + 30 + (index * 30), option, {
                        fontSize: '20px',
                        color: '#000000',
                        backgroundColor: '#ffffff'
                    }).setOrigin(0.5);
                    optionElement.setInteractive({ draggable: true });
                    optionElements.push(optionElement);
                });
                return optionElements;
            }

            setupOptionInteraction(optionElements, chatBox, chatText, npcFace, chatElements) {
                this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
                    gameObject.x = dragX;
                    gameObject.y = dragY;
                });

                this.input.on('dragend', (pointer, gameObject) => {
                    if (Phaser.Geom.Intersects.RectangleToRectangle(gameObject.getBounds(), chatBox.getBounds())) {
                        this.input.removeListener('drag');
                        this.input.removeListener('dragend');

                        chatText.text = '';
                        const playerChatElements = this.createChatElements('playerface');
                        chatBox.destroy();
                        npcFace.destroy();
                        const { chatBox: newChatBox, chatText: newChatText, face: playerFace } = playerChatElements;

                        this.animateText(newChatText, gameObject.text, () => {
                            optionElements.forEach(option => option.destroy());

                            const indicator = this.add.triangle(newChatBox.x, newChatBox.y + newChatBox.height / 2, 0, 0, 10, 20, 20, 0, 0xff0000).setStrokeStyle(2, 0x000000);
                            this.input.keyboard.once('keydown-ENTER', () => {
                                indicator.destroy();
                                newChatBox.destroy();
                                newChatText.destroy();
                                playerFace.destroy();

                                const nextDialogue = this.dialogueData.dialogues[this.dialogueIndex + 1];
                                if (nextDialogue && nextDialogue.responses && nextDialogue.responses[gameObject.text]) {
                                    this.dialogueIndex++;
                                    const response = nextDialogue.responses[gameObject.text];
                                    this.dialogueData.dialogues[this.dialogueIndex] = response;
                                    this.showDialogue();
                                } else {
                                    this.inAction = false;
                                }
                            });
                        });
                    } else {
                        gameObject.setPosition(gameObject.input.dragStartX, gameObject.input.dragStartY);
                    }
                });
            }

            update() {

                const speed = window.innerWidth * 0.22;
                if ((this.cursors.left.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A).isDown) && !this.inAction) {
                    this.main_character.setVelocityX(-speed);
                    this.main_character.flipX = true;
                } else if ((this.cursors.right.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D).isDown) && !this.inAction) {
                    this.main_character.setVelocityX(speed);
                    this.main_character.flipX = false;
                } else {
                    this.main_character.setVelocityX(0);
                }
                if ((this.cursors.up.isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE).isDown || this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W).isDown) && this.main_character.body.touching.down && !this.inAction) {
                    this.main_character.setVelocityY(-speed);
                }
                if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER)) && this.action && !this.inAction) {
                    this.startConversation();
                    this.exclamation.setVisible(false);
                }

                if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)) && this.inAction) {
                    this.inAction = false;

                }
                this.hideExclamation();
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            scene: Arvandor,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 750 }
                }
            },
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            render: {
                pixelArt: true
            }
        };

        const game = new Phaser.Game(config);
    </script>

</body>

</html>